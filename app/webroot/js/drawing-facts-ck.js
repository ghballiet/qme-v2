$(document).ready(function(){});var facts=function(){function b(){a.select("circle.saving").transition().duration(250).attr("opacity",1)}function c(){a.select("circle.saving").transition().duration(250).attr("opacity",0)}function d(a){a.attr("opacity",.5)}function e(a){a.transition().duration(200).attr("opacity",1)}function f(a){d(a);q()}function g(a){e(a);h(a);p()}function h(a){var d=a.datum(),e={Place:d},f="../../update_place";b();$.post(f,e,function(a){c()})}function i(a){var d=a.datum(),e={Entity:d},f="../../update_entity";b();$.post(f,e,function(a){c()})}function m(){a=d3.select("#facts").append("svg");var b=a.selectAll("circle.saving").data([{cx:15,cy:15,r:5}]).enter().append("circle").attr("class","saving").attr("opacity",0).attr("cx",function(a){return a.cx}).attr("cy",function(a){return a.cy}).attr("r",function(a){return a.r});n();o();p()}function n(){var b=a.selectAll("g.place").data(json.places).enter().append("g").attr("class",function(a){return"place place"+a.id}).attr("opacity",1).attr("data-id",function(a){return a.id}).attr("data-parent",function(a){return a.parent?a.parent:null}).attr("transform",function(a){return"translate("+a.x+","+a.y+")"}).call(j);b.append("rect").attr("width",function(a){return a.width}).attr("height",function(a){return a.height});b.append("text").attr("text-anchor","middle").attr("x",function(a){return a.width/2}).attr("dy","1.6em").text(function(a){return a.name});b.append("circle").attr("r",7).attr("cx",function(a){return a.width}).attr("cy",function(a){return a.height}).attr("group",function(a){return"place"+a.id}).call(k);$(".place").each(function(){var a=$(this).data();if(a.parent&&$(".place"+a.parent).length>0){var b=$(".place"+a.parent);b.append($(this))}})}function o(){var b=100,c=30,d=a.selectAll("g.entitiy").data(json.entities).enter().append("g").attr("class",function(a){return"entity entity"+a.id+" "+a.type}).attr("opacity",1).attr("data-id",function(a){return a.id}).attr("data-location",function(a){return a.location}).attr("transform",function(a){return"translate("+a.x+","+a.y+")"}).call(l);d.append("rect").attr("width",b).attr("height",c);d.append("text").attr("text-anchor","middle").attr("x",b/2).attr("dy","1.6em").text(function(a){return a.name});$(".entity").each(function(){var a=$(this).data();if($(".place"+a.location).length>0){var b=$(".place"+a.location);b.append($(this))}})}function p(){var b=$("#facts").offset().left,c=$("#facts").offset().top;for(var d in json.facts){var e=json.facts[d],f=e.start.id,g=e.end.id,h=s(f),i=s(g),j='.entity[data-id="'+f+'"]',k='.entity[data-id="'+g+'"]',l=$(j),m=$(k),n=a.select(j+" rect"),o=a.select(k+" rect"),p=l.offset().left-b,q=l.offset().top-c,t=m.offset().left-b,u=m.offset().top-c,v=parseInt(n.attr("height")),w=parseInt(n.attr("width")),x=parseInt(o.attr("height")),y=parseInt(o.attr("width")),z=d3.svg.diagonal().source(function(a,b){return a.start.pos}).target(function(a,b){return a.end.pos}),A=i.x,B=i.y,C=h.x,D=h.y,E=r(C,D,A,B),F=r(C,D,p,q),G=r(C,D,p+w,q),H=r(C,D,p+w,q+v),I=r(C,D,p,q+v),J=null,K=h,L=i;E>=F&&E<G?J="top":E>=G&&E<H?J="right":E>=H&&E<I?J="bottom":J="left";if(J=="top"){K.y=q;L.y=u+x}else if(J=="right"){K.x=p+w;L.x=t}else if(J=="bottom"){K.y=q+v;L.y=u}else if(J=="left"){K.x=p;L.x=t+y}json.facts[d].start.pos=K;json.facts[d].end.pos=L}var e=a.selectAll("line.fact").data(json.facts).enter().append("line").attr("class",function(a){return"fact "+a.type}).attr("data-start",function(a){return a.start.id}).attr("data-start",function(a){return a.start.id}).attr("data-end",function(a){return a.end.id}).attr("data-type",function(a){return a.type}).attr("x1",function(a){return a.start.pos.x}).attr("x2",function(a){return a.end.pos.x}).attr("y1",function(a){return a.start.pos.y}).attr("y2",function(a){return a.end.pos.y}).attr("marker-end",function(a){return"url(#"+a.type+")"})}function q(){a.selectAll("line.fact").remove()}function r(a,b,c,d){var e=parseFloat(b-d),f=parseFloat(a-c),g=Math.atan2(e,f),h=g*180/Math.PI;h<0&&(h+=360);return h}function s(b){var c='.entity[data-id="'+b+'"]',d=a.select(c),e=a.select(c+" rect"),f=d.datum(),g=$("#facts").offset().left,h=$("#facts").offset().top,i=$(c).offset().left-g,j=$(c).offset().top-h,k=parseInt(e.attr("width")),l=parseInt(e.attr("height")),m=i+k/2-7,n=j+l/2;return{x:m,y:n}}var a=null,j=d3.behavior.drag().on("dragstart",function(){d3.select(this).call(f)}).on("drag",function(a,b){a.x+=d3.event.dx;a.y+=d3.event.dy;d3.select(this).attr("transform","translate("+a.x+","+a.y+")")}).on("dragend",function(){d3.select(this).call(g)}),k=d3.behavior.drag().on("dragstart",function(){}).on("drag",function(b,c){var d=d3.select(this),e=d.attr("group"),f=a.select("."+e+" rect"),g=a.select("."+e+" text"),h=parseInt(f.attr("width"))+d3.event.dx,i=parseInt(f.attr("height"))+d3.event.dy,j=parseInt(d.attr("cx"))+d3.event.dx,k=parseInt(d.attr("cy"))+d3.event.dy,l=parseInt(d.attr("r"));if(h>50&&i>50){d.attr("cx",j).attr("cy",k);f.attr("height",i).attr("width",h);g.attr("x",h/2)}}).on("dragend",function(b,c){var d=d3.select(this),e=d.attr("group"),f=a.select("."+f),g=a.select("."+e+" rect"),i=parseInt(g.attr("height")),j=parseInt(g.attr("width")),k=g.datum();k.height=i;k.width=j;g.datum(k);g.call(h)}),l=d3.behavior.drag().on("dragstart",function(){d3.select(this).call(d);q()}).on("drag",function(a,b){a.x+=d3.event.dx;a.y+=d3.event.dy;d3.select(this).attr("transform","translate("+a.x+","+a.y+")")}).on("dragend",function(){d3.select(this).call(e).call(i);p()});m()};